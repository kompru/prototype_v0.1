<!DOCTYPE html>
<html>
<head>
  <title>Text to Google Sheets</title>
  <style>
    /* Marked Change: Set the width of the input field */
    #address {
      width: 300px;
    }
    #product {
      width: 200px;
    }
    #productSearch {
      display: none;
    }
  </style>
</head>
<body>

<input type="text" id="address">
<button onclick="sendText()">Enviar</button>
<div id="searchAddress"></div> <!-- This is where the text will be displayed -->

<br>

<div id="productSearch">
  <span>Produto que quer buscar:</span>
  <input type="text" id="product">
  <button onclick="buscar()">Buscar</button>
</div>

<!-- This is where the search status will be displayed -->
<div id="searchStatus"></div>

<script>
  var autocomplete;
  var zipcode = "";

  function initAutocomplete() {
    var options = {
      types: ['address'],
      componentRestrictions: {'country': 'br'}
    };
    
    autocomplete = new google.maps.places.Autocomplete(document.getElementById('address'), options);
    autocomplete.addListener('place_changed', fillInAddress);
  }

  function fillInAddress() {
    var place = autocomplete.getPlace();
    
    zipcode = "";  // Reset the ZIP code
    for (var i = 0; i < place.address_components.length; i++) {
      var addressType = place.address_components[i].types[0];
      if (addressType === "postal_code") {
        zipcode = place.address_components[i]['long_name'];
      }
    }

  }

  async function sendText() {
    let text = document.getElementById("address").value;
    if (zipcode) {  // Only append if ZIP exists
      text += ", " + zipcode; 
    }
    document.getElementById("searchAddress").innerText = 'EndereÃ§o de pesquisa: ' + text;
    document.getElementById("productSearch").style.display = 'block';

    const response = await fetch('http://localhost:3000/save-text', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text})
    });
    
    const result = await response.json();
    alert(result.message);
  }
  
  // Marked Change: New function to handle the "Buscar" button
  async function buscar() {
    const product = document.getElementById("product").value;
    document.getElementById("searchStatus").innerText = "Buscando '" + product + "':";

    const response = await fetch('http://localhost:3000/save-product', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({product})
    });

    const result = await response.json();
    alert(result.message);
  }

// New Code: Function to load Google Maps API dynamically
async function loadGoogleMapsAPI() {
  const res = await fetch('http://localhost:3000/get-google-maps-key');
  const data = await res.json();
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${data.googleMapsApiKey}&libraries=places&callback=initAutocomplete`;
  script.async = true;
  script.defer = true;
  document.body.appendChild(script);
}

// New Code: Load Google Maps API
loadGoogleMapsAPI();
  
</script>
<!-- Removed the previous <script> for Google Maps API -->
</body>
</html>
